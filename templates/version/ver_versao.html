{% extends "base.html" %}

{% block content %}
<style>
    .exercicio-item {
        transition: all 0.2s;
        border-left: 3px solid transparent;
        padding: 10px;
        margin-bottom: 5px;
        background: #f8f9fa;
        border-radius: 5px;
    }
    .exercicio-item:hover {
        background-color: #fff3e0;
        border-left-color: #F28C33;
    }
    .btn-remover-exercicio {
        opacity: 0.3;
        transition: opacity 0.2s;
    }
    .exercicio-item:hover .btn-remover-exercicio {
        opacity: 1;
    }
    .drag-handle {
        cursor: grab;
        color: #aaa;
        transition: color 0.2s;
    }
    .drag-handle:hover {
        color: #F28C33;
    }
    .edit-section {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 30px;
        border-left: 5px solid #F28C33;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="bi bi-pencil-square me-2" style="color: #F28C33;"></i>
        Editar Versão {{ versao.versao }}: {{ versao.descricao }}
    </h2>
    <div>
        <a href="{{ url_for('version.gerenciar_versoes_global') }}" class="btn btn-outline-secondary me-2">
            <i class="bi bi-arrow-left"></i> Voltar
        </a>
        <a href="{{ url_for('version.novo_treino_na_versao', versao_id=versao.id) }}" 
           class="btn" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white; border: none;">
            <i class="bi bi-plus-circle"></i> Novo Treino
        </a>
    </div>
</div>

<!-- SEÇÃO DE EDIÇÃO DA VERSÃO -->
<div class="edit-section">
    <h5 class="mb-3">
        <i class="bi bi-tag" style="color: #F28C33;"></i> 
        Dados da Versão
    </h5>
    <form method="post">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label fw-bold">Descrição</label>
                <input type="text" name="descricao" class="form-control" 
                       value="{{ versao.descricao }}" required>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label fw-bold">Data de Início</label>
                <input type="date" name="data_inicio" class="form-control" 
                       value="{{ versao.data_inicio }}" required>
            </div>
            <div class="col-md-3 mb-3">
                <label class="form-label fw-bold">Data de Fim</label>
                <input type="date" name="data_fim" class="form-control" 
                       value="{{ versao.data_fim or '' }}">
                <small class="text-muted">Deixe em branco se for a versão atual</small>
            </div>
        </div>
        <div class="mt-2">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white; border: none;">
                <i class="bi bi-save"></i> Salvar Alterações da Versão
            </button>
        </div>
    </form>
</div>

<!-- Informações da Versão -->
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">Período</h6>
                <h5>{{ versao.data_inicio_formatada }} até {{ versao.data_fim_formatada or 'Atual' }}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">Total de Treinos</h6>
                <h5>{{ versao.treinos|length }}</h5>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6 class="text-muted">Total de Exercícios</h6>
                <h5>
                    {% set total = namespace(value=0) %}
                    {% for t in versao.treinos.values() %}
                        {% set total.value = total.value + t.exercicios|length %}
                    {% endfor %}
                    {{ total.value }}
                </h5>
            </div>
        </div>
    </div>
</div>

<!-- Lista de Treinos -->
<div class="row">
    {% for treino_id, treino in versao.treinos.items() %}
    <div class="col-md-6 mb-4">
        <div class="card h-100">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <span class="badge me-2" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%);">
                        {{ treino_id }}
                    </span>
                    {{ treino.nome }}
                </h5>
                <div class="btn-group">
                    <a href="{{ url_for('version.editar_treino_na_versao', versao_id=versao.id, treino_codigo=treino_id) }}" 
                       class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <a href="{{ url_for('version.excluir_treino_da_versao', versao_id=versao.id, treino_codigo=treino_id) }}" 
                       class="btn btn-sm btn-outline-danger"
                       onclick="return confirm('Remover este treino da versão?')">
                        <i class="bi bi-trash"></i>
                    </a>
                </div>
            </div>
            <div class="card-body">
                <p class="text-muted small">{{ treino.descricao }}</p>
                                
                <div class="exercicios-container" id="exercicios-{{ treino_id }}" data-treino-id="{{ treino_id }}">
                    {% for ex_id in treino.exercicios %}
                        {% set exercicio = exercicios|selectattr('id', 'equalto', ex_id)|first %}
                        {% if exercicio %}
                        <div class="exercicio-item d-flex justify-content-between align-items-center" 
                             data-exercicio-id="{{ ex_id }}">
                            <div class="d-flex align-items-center flex-grow-1">
                                <i class="bi bi-grip-vertical drag-handle me-2"></i>
                                <div>
                                    <strong>{{ exercicio.nome }}</strong>
                                    <br><small class="text-muted">{{ exercicio.musculo_ref.nome_exibicao if exercicio.musculo_ref else 'N/A' }}</small>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-link text-danger btn-remover-exercicio" 
                                    onclick="removerExercicio({{ versao.id }}, '{{ treino_id }}', {{ ex_id }})">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                        {% endif %}
                    {% endfor %}
                </div>
                
                <button class="btn btn-sm btn-outline-primary mt-3" 
                        onclick="abrirModalAdicionar({{ versao.id }}, '{{ treino_id }}')">
                    <i class="bi bi-plus-circle"></i> Adicionar Exercício
                </button>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> 
            Nenhum treino cadastrado nesta versão.
            <a href="{{ url_for('version.novo_treino_na_versao', versao_id=versao.id) }}" class="alert-link">
                Criar primeiro treino
            </a>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Modal para Adicionar Exercício -->
<div class="modal fade" id="modalAdicionarExercicio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Adicionar Exercício
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="modal_versao_id">
                <input type="hidden" id="modal_treino_id">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Buscar exercício</label>
                    <input type="text" id="buscaExercicio" class="form-control" 
                           placeholder="Digite para buscar...">
                </div>
                
                <div id="resultadosBusca" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px;">
                    <div class="text-center p-3 text-muted">
                        Digite para buscar exercícios
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
    let versaoAtual, treinoAtual;
    
    document.addEventListener('DOMContentLoaded', function() {
        {% for treino_id in versao.treinos.keys() %}
            const container = document.getElementById('exercicios-{{ treino_id }}');
            if (container) {
                new Sortable(container, {
                    animation: 150,
                    handle: '.drag-handle',
                    onEnd: function(evt) {
                        const novaOrdem = Array.from(container.children).map(
                            item => parseInt(item.dataset.exercicioId)
                        );
                        
                        fetch(`/version/versao/{{ versao.id }}/treino/{{ treino_id }}/reordenar`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                            },
                            body: JSON.stringify({nova_ordem: novaOrdem})
                        });
                    }
                });
            }
        {% endfor %});
    });
    
    function abrirModalAdicionar(versaoId, treinoId) {
        versaoAtual = versaoId;
        treinoAtual = treinoId;
        
        document.getElementById('modal_versao_id').value = versaoId;
        document.getElementById('modal_treino_id').value = treinoId;
        
        const modal = new bootstrap.Modal(document.getElementById('modalAdicionarExercicio'));
        modal.show();
        
        // Inicializar busca
        const input = document.getElementById('buscaExercicio');
        input.value = '';
        input.focus();
        
        document.getElementById('resultadosBusca').innerHTML = '<div class="text-center p-3 text-muted">Digite para buscar exercícios</div>';
        
        // Configurar busca
        let timeout;
        input.addEventListener('input', function() {
            clearTimeout(timeout);
            const termo = this.value.trim();
            
            if (termo.length < 2) {
                document.getElementById('resultadosBusca').innerHTML = '<div class="text-center p-3 text-muted">Digite para buscar exercícios</div>';
                return;
            }
            
            timeout = setTimeout(() => {
                fetch(`/api/buscar-exercicios?termo=${encodeURIComponent(termo)}`)
                    .then(r => r.json())
                    .then(data => {
                        const div = document.getElementById('resultadosBusca');
                        if (data.length === 0) {
                            div.innerHTML = '<div class="text-center p-3 text-muted">Nenhum exercício encontrado</div>';
                            return;
                        }
                        
                        div.innerHTML = data.map(ex => `
                            <div class="card mb-2" style="cursor: pointer;" onclick="adicionarExercicio(${ex.id})">
                                <div class="card-body py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>${ex.nome}</strong>
                                            <br><small class="text-muted">${ex.musculo}</small>
                                        </div>
                                        <i class="bi bi-plus-circle text-success"></i>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    });
            }, 300);
        });
    }
    
    function adicionarExercicio(exercicioId) {
        fetch(`/version/versao/${versaoAtual}/treino/${treinoAtual}/exercicio/adicionar`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({exercicio_id: exercicioId})
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao adicionar exercício');
            }
        });
    }
    
    function removerExercicio(versaoId, treinoId, exercicioId) {
        if (confirm('Remover este exercício do treino?')) {
            fetch(`/version/versao/${versaoId}/treino/${treinoId}/exercicio/${exercicioId}/remover`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
                }
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                }
            });
        }
    }
</script>
{% endblock %}