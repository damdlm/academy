{% extends "base.html" %}
{% block content %}

<style>
    .btn-group .btn-outline-primary {
        border-color: #F28C33;
        color: #F28C33;
    }
    .btn-group .btn-outline-primary:hover {
        background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%);
        color: white;
        border-color: transparent;
    }
    .btn-group .btn-outline-danger:hover {
        background: #dc3545;
        color: white;
        border-color: transparent;
    }
    
    /* Animação suave para os cards de treino */
    .list-group-item {
        transition: all 0.3s ease;
    }
    .list-group-item:hover {
        transform: translateX(5px);
        box-shadow: -5px 0 0 #F28C33;
    }
    
    /* Estilo para as abas de treino */
    .treino-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 20px;
    }
    
    .treino-tabs .nav-link {
        color: #495057 !important;
        font-weight: 600;
        padding: 12px 20px;
        margin-right: 5px;
        border: none !important;
        border-radius: 10px 10px 0 0 !important;
        transition: all 0.3s ease;
        position: relative;
    }
    
    .treino-tabs .nav-link:hover {
        color: #F28C33 !important;
        background-color: rgba(242, 140, 51, 0.1) !important;
        transform: translateY(-2px);
    }
    
    .treino-tabs .nav-link.active {
        color: #F28C33 !important;
        background: linear-gradient(to top, rgba(242, 140, 51, 0.1), transparent) !important;
        font-weight: 700;
    }
    
    .treino-tabs .nav-link.active::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, #F28C33, #FFB366);
        border-radius: 3px 3px 0 0;
    }
    
    /* Badge para número de exercícios */
    .exercicio-count {
        background-color: #F28C33;
        color: white;
        border-radius: 20px;
        padding: 2px 8px;
        font-size: 0.8em;
        margin-left: 8px;
    }
</style>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">
        <i class="bi bi-gear-fill me-2" style="color: #F28C33;"></i>Gerenciar Catálogo de Exercícios
    </h2>
    <div class="d-flex gap-2">
        <button type="button" class="btn" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white; border: none;" data-bs-toggle="modal" data-bs-target="#modalNovoTreino">
            <i class="bi bi-plus-circle"></i> Novo Treino
        </button>
        <button type="button" class="btn" style="background: #2D2D2D; color: white; border: none;" data-bs-toggle="modal" data-bs-target="#modalNovoExercicio">
            <i class="bi bi-database-add"></i> Novo Exercício
        </button>
    </div>
</div>

<!-- Modal Novo Treino -->
<div class="modal fade" id="modalNovoTreino" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> Novo Treino
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.salvar_treino') }}" method="post">
                <div class="modal-body">
				
                    <div class="mb-3">
                        <label class="form-label fw-bold">ID do Treino</label>
                        <input type="text" name="id" class="form-control" 
                               placeholder="Ex: F, G, H..." maxlength="1" required>
                        <div class="form-text">Uma única letra maiúscula</div>
                    </div>
					
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descrição</label>
                        <input type="text" name="descricao" class="form-control" 
                               placeholder="Ex: Costas, Peito, Pernas..." required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white; border: none;">Salvar Treino</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Treino -->
<div class="modal fade" id="modalEditarTreino" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFB366 0%, #F28C33 100%); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Editar Treino
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.editar_treino') }}" method="post" id="formEditarTreino">
                <div class="modal-body">
                    <input type="hidden" name="id_original" id="edit_treino_id_original">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">ID do Treino</label>
                        <input type="text" name="id" id="edit_treino_id" class="form-control" 
                               placeholder="Ex: F, G, H..." maxlength="1" required>
                        <div class="form-text">Uma única letra maiúscula</div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Descrição</label>
                        <input type="text" name="descricao" id="edit_treino_descricao" class="form-control" 
                               placeholder="Ex: Costas, Peito, Pernas..." required>
                    </div>
                    
                    <div class="alert alert-warning" id="edit_treino_alerta" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i> 
                        <span id="edit_treino_mensagem"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #FFB366 0%, #F28C33 100%); color: white; border: none;">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Novo Exercício -->
<div class="modal fade" id="modalNovoExercicio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: #2D2D2D; color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-database-add"></i> Novo Exercício
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.salvar_exercicio') }}" method="post" id="formNovoExercicio">
                <div class="modal-body">
                    <!-- Abas para seleção ou criação manual -->
                    <ul class="nav nav-tabs mb-3" id="novoExercicioTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="selecionar-tab" data-bs-toggle="tab" data-bs-target="#selecionar" type="button" role="tab"
                                    style="color: #F28C33 !important;">
                                <i class="bi bi-search"></i> Selecionar do Catálogo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="criar-tab" data-bs-toggle="tab" data-bs-target="#criar" type="button" role="tab"
                                    style="color: #F28C33 !important;">
                                <i class="bi bi-pencil"></i> Criar Manualmente
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Conteúdo das abas -->
                    <div class="tab-content">
                        <!-- Aba de Seleção do Catálogo -->
                        <div class="tab-pane fade show active" id="selecionar" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Buscar Exercício</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" id="buscaExercicio" class="form-control" 
                                           placeholder="Digite para buscar exercícios..." autocomplete="off">
                                </div>
                                <small class="text-muted">Digite pelo menos 2 caracteres para buscar</small>
                            </div>
                            
                            <div id="resultadosBusca" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; display: none;">
                                <div class="list-group" id="listaResultados"></div>
                            </div>
                            
                            <div class="mt-3" id="exercicioSelecionadoInfo" style="display: none;">
                                <div class="alert alert-success">
                                    <h6 class="alert-heading">Exercício Selecionado:</h6>
                                    <p class="mb-1"><strong>Nome:</strong> <span id="selectedNome"></span></p>
                                    <p class="mb-0"><strong>Músculo:</strong> <span id="selectedMusculo"></span></p>
                                </div>
                                <input type="hidden" id="selectedNomeInput" name="nome_catalogo">
                                <input type="hidden" id="selectedMusculoInput" name="musculo_catalogo">
                            </div>
                        </div>
                        
                        <!-- Aba de Criação Manual -->
                        <div class="tab-pane fade" id="criar" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label fw-bold">Nome do Exercício</label>
                                    <div class="input-group">
                                        <input type="text" name="nome_manual" id="manual_nome" class="form-control" 
                                               placeholder="Ex: Rosca direta">
                                        <button type="button" class="btn btn-outline-primary" onclick="buscarMusculoManual()">
                                            <i class="bi bi-search"></i> Buscar Músculo
                                        </button>
                                    </div>
                                    <small class="text-muted">Digite o nome e clique em "Buscar Músculo" para encontrar automaticamente</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Músculo</label>
                                    <select name="musculo_manual" id="manual_musculo" class="form-select">
                                        <option value="">Selecione ou busque...</option>
                                        {% for m in musculos %}
                                        <option value="{{ m }}">{{ m }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div id="resultadoBuscaManual" class="mt-2" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> <span id="mensagemBuscaManual"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos ocultos para enviar o formulário -->
                    <input type="hidden" name="nome" id="final_nome">
                    <input type="hidden" name="musculo" id="final_musculo">
                    
                    <div class="mb-3 mt-3">
                        <label class="form-label fw-bold">Treino</label>
                        <select name="treino" id="novo_treino" class="form-select" required>
                            <option value="">Selecione...</option>
                            {% for t in treinos %}
                            <option value="{{ t.id }}">{{ t.id }} - {{ t.descricao }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn" style="background: #2D2D2D; color: white; border: none;" onclick="return prepararEnvioNovo()">Salvar Exercício</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Editar Exercício -->
<div class="modal fade" id="modalEditarExercicio" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #FFB366 0%, #F28C33 100%); color: white;">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Editar Exercício
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('admin.editar_exercicio') }}" method="post" id="formEditarExercicio">
                <div class="modal-body">
                    <input type="hidden" name="id" id="edit_exercicio_id">
                    
                    <!-- Abas para edição -->
                    <ul class="nav nav-tabs mb-3" id="editExercicioTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="edit-selecionar-tab" data-bs-toggle="tab" data-bs-target="#edit-selecionar" type="button" role="tab"
                                    style="color: #F28C33 !important;">
                                <i class="bi bi-search"></i> Buscar no Catálogo
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="edit-manual-tab" data-bs-toggle="tab" data-bs-target="#edit-manual" type="button" role="tab"
                                    style="color: #F28C33 !important;">
                                <i class="bi bi-pencil"></i> Editar Manualmente
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Aba de Busca no Catálogo -->
                        <div class="tab-pane fade show active" id="edit-selecionar" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Buscar Exercício</label>
                                <div class="input-group">
                                    <span class="input-group-text"><i class="bi bi-search"></i></span>
                                    <input type="text" id="edit_buscaExercicio" class="form-control" 
                                           placeholder="Digite para buscar exercícios..." autocomplete="off">
                                </div>
                                <small class="text-muted">Digite pelo menos 2 caracteres para buscar</small>
                            </div>
                            
                            <div id="edit_resultadosBusca" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 5px; padding: 10px; display: none;">
                                <div class="list-group" id="edit_listaResultados"></div>
                            </div>
                            
                            <div class="mt-3" id="edit_exercicioSelecionadoInfo" style="display: none;">
                                <div class="alert alert-success">
                                    <h6 class="alert-heading">Exercício Selecionado:</h6>
                                    <p class="mb-1"><strong>Nome:</strong> <span id="edit_selectedNome"></span></p>
                                    <p class="mb-0"><strong>Músculo:</strong> <span id="edit_selectedMusculo"></span></p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Aba de Edição Manual -->
                        <div class="tab-pane fade" id="edit-manual" role="tabpanel">
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label fw-bold">Nome do Exercício</label>
                                    <div class="input-group">
                                        <input type="text" id="edit_manual_nome" class="form-control" 
                                               placeholder="Ex: Rosca direta">
                                        <button type="button" class="btn btn-outline-primary" onclick="buscarMusculoEditManual()">
                                            <i class="bi bi-search"></i> Buscar Músculo
                                        </button>
                                    </div>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label fw-bold">Músculo</label>
                                    <select id="edit_manual_musculo" class="form-select">
                                        <option value="">Selecione ou busque...</option>
                                        {% for m in musculos %}
                                        <option value="{{ m }}">{{ m }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div id="edit_resultadoBuscaManual" class="mt-2" style="display: none;">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> <span id="edit_mensagemBuscaManual"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Campos ocultos para enviar o formulário -->
                    <input type="hidden" name="nome" id="edit_final_nome">
                    <input type="hidden" name="musculo" id="edit_final_musculo">
                    
                    <div class="mb-3 mt-3">
                        <label class="form-label fw-bold">Treino</label>
                        <select name="treino" id="edit_treino" class="form-select" required>
                            {% for t in treinos %}
                            <option value="{{ t.id }}">{{ t.id }} - {{ t.descricao }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn" style="background: linear-gradient(135deg, #FFB366 0%, #F28C33 100%); color: white; border: none;" onclick="return prepararEnvioEdit()">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Lista de Treinos -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card">			
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-trophy" style="color: #F28C33;"></i> Treinos
                </h5>
            </div>
			
            <div class="card-body">
                <div class="list-group">
                    {% for t in treinos %}
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            <span class="badge me-2" style="background: linear-gradient(135deg, #F28C33 0%, #FFB366 100%); color: white;">{{ t.id }}</span>
                            <strong>{{ t.descricao }}</strong>
                        </div>
                        <div class="btn-group">
                            <!-- Botão de Versões - CORRIGIDO (Opção 1) -->
                            <a href="{{ url_for('version.gerenciar_versoes_global') }}" 
                               class="btn btn-sm btn-info" 
                               style="background: #17a2b8; color: white; border: none;">
                                <i class="bi bi-clock-history"></i> Versões
                            </a>
                            <button class="btn btn-sm" style="background: linear-gradient(135deg, #FFB366 0%, #F28C33 100%); color: white; border: none;" 
                                    onclick="editarTreino('{{ t.id }}', '{{ t.descricao }}')">
                                <i class="bi bi-pencil"></i>
                            </button>					
                            <button class="btn btn-sm btn-danger" 
                                    onclick="confirmarExclusaoTreino('{{ t.id }}', '{{ t.descricao }}')">
                                <i class="bi bi-trash"></i>
                            </button>					
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Lista de Exercícios -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-list-check" style="color: #F28C33;"></i> Exercícios
                </h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs treino-tabs mb-3" id="exercicioTabs">
                    {% for t in treinos %}
                    <li class="nav-item">
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                data-bs-toggle="tab" data-bs-target="#treino{{ t.id }}">
                            Treino {{ t.id }}
                        </button>
                    </li>
                    {% endfor %}
                </ul> 
                <div class="tab-content">
                    {% for t in treinos %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" id="treino{{ t.id }}">
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Exercício</th>
                                        <th>Músculo</th>
                                        <th>Última Carga</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for ex in exercicios if ex.treino == t.id %}
                                    <tr>
                                        <td>{{ ex.nome }}</td>
                                        <td>{{ ex.musculo }}</td>
                                        <td>
                                            {% set ultima = ultimas_cargas.get(ex.id) %}
                                            {% if ultima %}
                                                <span class="badge bg-secondary">{{ ultima }}kg</span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <div class="btn-group">
                                                <a href="{{ url_for('admin.exercicio_detalhes', exercicio_id=ex.id) }}" 
                                                   class="btn btn-sm btn-info"
                                                   style="background: #17a2b8; color: white; border: none;">
                                                    <i class="bi bi-info-circle"></i>
                                                </a>
                                                <button class="btn btn-sm" style="background: linear-gradient(135deg, #FFB366 0%, #F28C33 100%); color: white; border: none;" 
                                                        onclick="editarExercicio({{ ex.id }}, '{{ ex.nome }}', '{{ ex.musculo }}', '{{ ex.treino }}')">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="confirmarExclusaoExercicio({{ ex.id }}, '{{ ex.nome }}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Variáveis para controle de debounce e paginação
    let buscaTimeout;
    let editBuscaTimeout;
    let todosResultados = [];
    let resultadosExibidos = 50;
    
    // ===== FUNÇÕES PARA NOVO EXERCÍCIO =====
    
    // Busca exercícios no catálogo (com debounce)
    document.getElementById('buscaExercicio')?.addEventListener('input', function() {
        clearTimeout(buscaTimeout);
        const termo = this.value.trim();
        
        if (termo.length < 2) {
            document.getElementById('resultadosBusca').style.display = 'none';
            return;
        }
        
        // Mostra loading
        const listaDiv = document.getElementById('listaResultados');
        listaDiv.innerHTML = '<div class="list-group-item text-center"><div class="spinner-border spinner-border-sm"></div> Carregando...</div>';
        document.getElementById('resultadosBusca').style.display = 'block';
        
        buscaTimeout = setTimeout(() => {
            fetch(`/api/buscar-exercicios?termo=${encodeURIComponent(termo)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na requisição');
                    }
                    return response.json();
                })
                .then(data => {
                    todosResultados = data;
                    resultadosExibidos = 50;
                    exibirResultadosPaginados('novo');
                })
                .catch(error => {
                    console.error('Erro na busca:', error);
                    listaDiv.innerHTML = '<div class="list-group-item text-danger">Erro ao carregar resultados</div>';
                });
        }, 300);
    });
    
    function exibirResultadosPaginados(tipo) {
        const listaDiv = tipo === 'novo' ? document.getElementById('listaResultados') : document.getElementById('edit_listaResultados');
        if (!listaDiv) return;
        
        listaDiv.innerHTML = '';
        
        const resultadosParaExibir = todosResultados.slice(0, resultadosExibidos);
        
        if (resultadosParaExibir.length === 0) {
            listaDiv.innerHTML = '<div class="list-group-item text-muted">Nenhum exercício encontrado</div>';
            return;
        }
        
        resultadosParaExibir.forEach(ex => {
            const item = document.createElement('a');
            item.href = '#';
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `<strong>${ex.nome}</strong><br><small class="text-muted">Músculo: ${ex.musculo}</small>`;
            item.onclick = (e) => {
                e.preventDefault();
                if (tipo === 'novo') {
                    selecionarExercicio(ex.nome, ex.musculo);
                } else {
                    selecionarExercicioEdit(ex.nome, ex.musculo);
                }
            };
            listaDiv.appendChild(item);
        });
        
        if (todosResultados.length > resultadosExibidos) {
            const contador = document.createElement('div');
            contador.className = 'list-group-item text-muted text-center';
            contador.innerHTML = `<small>${todosResultados.length - resultadosExibidos} resultados restantes. <a href="#" onclick="carregarMaisResultados('${tipo}'); return false;">Carregar mais</a></small>`;
            listaDiv.appendChild(contador);
        }
    }
    
    function carregarMaisResultados(tipo) {
        resultadosExibidos += 50;
        exibirResultadosPaginados(tipo);
    }
    
    function selecionarExercicio(nome, musculo) {
        if (!nome || !musculo) {
            alert('Erro: Dados do exercício inválidos');
            return;
        }
        document.getElementById('selectedNome').textContent = nome;
        document.getElementById('selectedMusculo').textContent = musculo;
        document.getElementById('selectedNomeInput').value = nome;
        document.getElementById('selectedMusculoInput').value = musculo;
        document.getElementById('exercicioSelecionadoInfo').style.display = 'block';
        document.getElementById('resultadosBusca').style.display = 'none';
        document.getElementById('buscaExercicio').value = '';
    }
    
    function buscarMusculoManual() {
        const nome = document.getElementById('manual_nome').value.trim();
        const resultadoDiv = document.getElementById('resultadoBuscaManual');
        const mensagemSpan = document.getElementById('mensagemBuscaManual');
        const musculoSelect = document.getElementById('manual_musculo');
        
        if (!nome) {
            alert('Digite o nome do exercício primeiro!');
            return;
        }
        
        if (!musculoSelect) {
            alert('Erro: Select de músculo não encontrado');
            return;
        }
        
        mensagemSpan.innerHTML = 'Buscando... <span class="spinner-border spinner-border-sm"></span>';
        resultadoDiv.style.display = 'block';
        
        fetch(`/api/buscar-musculo?nome=${encodeURIComponent(nome)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisição');
                }
                return response.json();
            })
            .then(data => {
                if (data.encontrado) {
                    mensagemSpan.innerHTML = `✅ Músculo encontrado: <strong>${data.musculo}</strong>`;
                    
                    let optionExists = false;
                    for (let i = 0; i < musculoSelect.options.length; i++) {
                        if (musculoSelect.options[i].value === data.musculo) {
                            musculoSelect.selectedIndex = i;
                            optionExists = true;
                            break;
                        }
                    }
                    
                    if (!optionExists) {
                        // Adiciona o músculo como opção se não existir
                        const newOption = document.createElement('option');
                        newOption.value = data.musculo;
                        newOption.text = data.musculo;
                        newOption.selected = true;
                        musculoSelect.appendChild(newOption);
                        mensagemSpan.innerHTML += `<br><small class="text-info">Músculo "${data.musculo}" adicionado à lista.</small>`;
                    }
                } else {
                    mensagemSpan.innerHTML = `❌ ${data.mensagem}`;
                }
            })
            .catch(error => {
                mensagemSpan.innerHTML = '❌ Erro ao buscar. Tente novamente.';
                console.error('Erro:', error);
            });
    }
    
    function prepararEnvioNovo() {
        const treino = document.getElementById('novo_treino').value;
        if (!treino) {
            alert('Selecione um treino!');
            return false;
        }
        
        // Verifica qual aba está ativa
        const activeTab = document.querySelector('#novoExercicioTabs .nav-link.active');
        
        if (activeTab && activeTab.id === 'selecionar-tab') {
            // Aba de seleção
            const nome = document.getElementById('selectedNomeInput').value;
            const musculo = document.getElementById('selectedMusculoInput').value;
            
            if (!nome) {
                alert('Selecione um exercício do catálogo!');
                return false;
            }
            
            document.getElementById('final_nome').value = nome;
            document.getElementById('final_musculo').value = musculo;
            
        } else {
            // Aba manual
            const nome = document.getElementById('manual_nome').value.trim();
            const musculo = document.getElementById('manual_musculo').value;
            
            if (!nome) {
                alert('Digite o nome do exercício!');
                return false;
            }
            
            document.getElementById('final_nome').value = nome;
            document.getElementById('final_musculo').value = musculo || '';
        }
        
        return true;
    }
    
    // ===== FUNÇÕES PARA EDITAR EXERCÍCIO =====
    
    function editarExercicio(id, nome, musculo, treino) {
        console.log('Editando exercício:', {id, nome, musculo, treino});
        
        // Preenche os campos do modal
        document.getElementById('edit_exercicio_id').value = id;
        document.getElementById('edit_manual_nome').value = nome;
        document.getElementById('edit_manual_musculo').value = musculo;
        document.getElementById('edit_treino').value = treino;
        
        // Atualiza também os campos ocultos
        document.getElementById('edit_final_nome').value = nome;
        document.getElementById('edit_final_musculo').value = musculo;
        
        // Mostra as informações do exercício atual na aba de busca
        document.getElementById('edit_selectedNome').textContent = nome;
        document.getElementById('edit_selectedMusculo').textContent = musculo;
        
        // Limpa resultados anteriores
        document.getElementById('edit_resultadosBusca').style.display = 'none';
        document.getElementById('edit_exercicioSelecionadoInfo').style.display = 'none';
        document.getElementById('edit_resultadoBuscaManual').style.display = 'none';
        document.getElementById('edit_buscaExercicio').value = '';
        
        // Reseta a aba para a primeira (Buscar no Catálogo)
        const tabTrigger = new bootstrap.Tab(document.querySelector('#edit-selecionar-tab'));
        tabTrigger.show();
        
        var modal = new bootstrap.Modal(document.getElementById('modalEditarExercicio'));
        modal.show();
    }
    
    // Busca exercícios no catálogo para edição
    document.getElementById('edit_buscaExercicio')?.addEventListener('input', function() {
        clearTimeout(editBuscaTimeout);
        const termo = this.value.trim();
        
        if (termo.length < 2) {
            document.getElementById('edit_resultadosBusca').style.display = 'none';
            return;
        }
        
        // Mostra loading
        const listaDiv = document.getElementById('edit_listaResultados');
        listaDiv.innerHTML = '<div class="list-group-item text-center"><div class="spinner-border spinner-border-sm"></div> Carregando...</div>';
        document.getElementById('edit_resultadosBusca').style.display = 'block';
        
        editBuscaTimeout = setTimeout(() => {
            fetch(`/api/buscar-exercicios?termo=${encodeURIComponent(termo)}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erro na requisição');
                    }
                    return response.json();
                })
                .then(data => {
                    todosResultados = data;
                    resultadosExibidos = 50;
                    exibirResultadosPaginados('edit');
                })
                .catch(error => {
                    console.error('Erro na busca:', error);
                    listaDiv.innerHTML = '<div class="list-group-item text-danger">Erro ao carregar resultados</div>';
                });
        }, 300);
    });
    
    function selecionarExercicioEdit(nome, musculo) {
        if (!nome || !musculo) {
            alert('Erro: Dados do exercício inválidos');
            return;
        }
        
        console.log('Selecionando exercício para edição:', {nome, musculo});
        
        // Atualiza os campos manuais
        document.getElementById('edit_manual_nome').value = nome;
        document.getElementById('edit_manual_musculo').value = musculo;
        
        // Atualiza os campos ocultos
        document.getElementById('edit_final_nome').value = nome;
        document.getElementById('edit_final_musculo').value = musculo;
        
        // Mostra informações do exercício selecionado
        document.getElementById('edit_selectedNome').textContent = nome;
        document.getElementById('edit_selectedMusculo').textContent = musculo;
        document.getElementById('edit_exercicioSelecionadoInfo').style.display = 'block';
        
        // Esconde a lista de resultados
        document.getElementById('edit_resultadosBusca').style.display = 'none';
        document.getElementById('edit_buscaExercicio').value = '';
        
        // Muda para a aba manual para mostrar os dados carregados
        const tabTrigger = new bootstrap.Tab(document.querySelector('#edit-manual-tab'));
        tabTrigger.show();
    }
    
    function buscarMusculoEditManual() {
        const nome = document.getElementById('edit_manual_nome').value.trim();
        const resultadoDiv = document.getElementById('edit_resultadoBuscaManual');
        const mensagemSpan = document.getElementById('edit_mensagemBuscaManual');
        const musculoSelect = document.getElementById('edit_manual_musculo');
        
        if (!nome) {
            alert('Digite o nome do exercício primeiro!');
            return;
        }
        
        if (!musculoSelect) {
            alert('Erro: Select de músculo não encontrado');
            return;
        }
        
        mensagemSpan.innerHTML = 'Buscando... <span class="spinner-border spinner-border-sm"></span>';
        resultadoDiv.style.display = 'block';
        
        fetch(`/api/buscar-musculo?nome=${encodeURIComponent(nome)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erro na requisição');
                }
                return response.json();
            })
            .then(data => {
                if (data.encontrado) {
                    mensagemSpan.innerHTML = `✅ Músculo encontrado: <strong>${data.musculo}</strong>`;
                    
                    let optionExists = false;
                    for (let i = 0; i < musculoSelect.options.length; i++) {
                        if (musculoSelect.options[i].value === data.musculo) {
                            musculoSelect.selectedIndex = i;
                            optionExists = true;
                            break;
                        }
                    }
                    
                    if (!optionExists) {
                        // Adiciona o músculo como opção se não existir
                        const newOption = document.createElement('option');
                        newOption.value = data.musculo;
                        newOption.text = data.musculo;
                        newOption.selected = true;
                        musculoSelect.appendChild(newOption);
                        mensagemSpan.innerHTML += `<br><small class="text-info">Músculo "${data.musculo}" adicionado à lista.</small>`;
                    }
                    
                    // Atualiza o campo oculto
                    document.getElementById('edit_final_musculo').value = data.musculo;
                    
                } else {
                    mensagemSpan.innerHTML = `❌ ${data.mensagem}`;
                }
            })
            .catch(error => {
                mensagemSpan.innerHTML = '❌ Erro ao buscar. Tente novamente.';
                console.error('Erro:', error);
            });
    }
    
    function prepararEnvioEdit() {
        const treino = document.getElementById('edit_treino').value;
        if (!treino) {
            alert('Selecione um treino!');
            return false;
        }
        
        const nome = document.getElementById('edit_manual_nome').value.trim();
        const musculo = document.getElementById('edit_manual_musculo').value;
        
        if (!nome) {
            alert('Digite o nome do exercício!');
            return false;
        }
        
        document.getElementById('edit_final_nome').value = nome;
        document.getElementById('edit_final_musculo').value = musculo || '';
        
        return true;
    }
    
    // ===== FUNÇÕES PARA EDITAR TREINO =====
    
    function editarTreino(id, descricao) {
        console.log('Editando treino:', {id, descricao});
        
        // Preenche os campos do modal
        document.getElementById('edit_treino_id_original').value = id;
        document.getElementById('edit_treino_id').value = id;
        document.getElementById('edit_treino_descricao').value = descricao;
        
        // Esconde alerta
        document.getElementById('edit_treino_alerta').style.display = 'none';
        
        var modal = new bootstrap.Modal(document.getElementById('modalEditarTreino'));
        modal.show();
    }
    
    // Validação de ID único no modal de edição
    document.getElementById('edit_treino_id')?.addEventListener('input', function() {
        const novoId = this.value.toUpperCase();
        const idOriginal = document.getElementById('edit_treino_id_original').value;
        const alertaDiv = document.getElementById('edit_treino_alerta');
        const mensagemSpan = document.getElementById('edit_treino_mensagem');
        
        // Se o ID não mudou, não precisa verificar
        if (novoId === idOriginal) {
            alertaDiv.style.display = 'none';
            return;
        }
        
        // Verifica se o ID já existe
        fetch(`/api/verificar-treino?id=${encodeURIComponent(novoId)}`)
            .then(response => response.json())
            .then(data => {
                if (data.existe) {
                    mensagemSpan.textContent = `O ID "${novoId}" já está em uso. Escolha outro.`;
                    alertaDiv.style.display = 'block';
                } else {
                    alertaDiv.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Erro ao verificar treino:', error);
            });
    });
    
    // Validação antes de enviar o formulário de edição de treino
    document.getElementById('formEditarTreino')?.addEventListener('submit', function(e) {
        const novoId = document.getElementById('edit_treino_id').value.toUpperCase();
        const idOriginal = document.getElementById('edit_treino_id_original').value;
        const descricao = document.getElementById('edit_treino_descricao').value.trim();
        
        if (!descricao) {
            e.preventDefault();
            alert('A descrição do treino não pode estar vazia!');
            return;
        }
        
        if (!novoId.match(/^[A-Z]$/)) {
            e.preventDefault();
            alert('O ID deve ser uma única letra maiúscula!');
            return;
        }
        
        // Se o ID mudou e o alerta de ID duplicado está visível, impede o envio
        if (novoId !== idOriginal && document.getElementById('edit_treino_alerta').style.display === 'block') {
            e.preventDefault();
            alert('Este ID já está em uso. Escolha outro.');
            return;
        }
    });
    
    // ===== FUNÇÕES DE EXCLUSÃO =====
    
    function confirmarExclusaoTreino(id, descricao) {
        if (confirm(`Tem certeza que deseja excluir o treino ${id} - ${descricao}?\nIsso também excluirá todos os exercícios e registros deste treino!`)) {
            window.location.href = `/excluir/treino/${id}`;
        }
    }
    
    function confirmarExclusaoExercicio(id, nome) {
        if (confirm(`Tem certeza que deseja excluir o exercício "${nome}"?\nIsso também excluirá todos os registros deste exercício!`)) {
            window.location.href = `/excluir/exercicio/${id}`;
        }
    }
    
    // ===== LIMPEZA AO ABRIR MODAIS =====
    
    document.getElementById('modalNovoExercicio')?.addEventListener('show.bs.modal', function () {
        document.getElementById('resultadosBusca').style.display = 'none';
        document.getElementById('exercicioSelecionadoInfo').style.display = 'none';
        document.getElementById('resultadoBuscaManual').style.display = 'none';
        document.getElementById('buscaExercicio').value = '';
        document.getElementById('manual_nome').value = '';
        document.getElementById('manual_musculo').value = '';
        document.getElementById('selectedNomeInput').value = '';
        document.getElementById('selectedMusculoInput').value = '';
        document.getElementById('final_nome').value = '';
        document.getElementById('final_musculo').value = '';
    });
    
    document.getElementById('modalEditarExercicio')?.addEventListener('show.bs.modal', function () {
        // Não limpamos os campos aqui porque são preenchidos na função editarExercicio
    });
    
    document.getElementById('modalEditarExercicio')?.addEventListener('hidden.bs.modal', function () {
        // Limpa os campos quando o modal é fechado
        document.getElementById('edit_buscaExercicio').value = '';
        document.getElementById('edit_resultadosBusca').style.display = 'none';
        document.getElementById('edit_exercicioSelecionadoInfo').style.display = 'none';
        document.getElementById('edit_resultadoBuscaManual').style.display = 'none';
    });
    
    document.getElementById('modalEditarTreino')?.addEventListener('hidden.bs.modal', function () {
        document.getElementById('edit_treino_alerta').style.display = 'none';
    });
</script>

{% endblock %}